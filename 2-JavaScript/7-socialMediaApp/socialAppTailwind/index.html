<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Social Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS STYLES */
        :root {
            --primary-blue: #1d9bf0;
            --light-bg: #f7f9f9;
            --text-color: #0f1419;
            --border-color: #eff3f4;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            color: var(--text-color);
        }

        .app-container {
            max-width: 600px;
            width: 100%;
            min-height: 100vh;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .post-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .view-content {
            display: none;
        }
        .view-content.active {
            display: block;
        }

        /* Toast Notification Styling */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .toast.show {
            opacity: 1;
        }

        /* Custom Prompt/Modal Styling for Delete */
        .confirm-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .confirm-modal {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 300px;
        }

    </style>
</head>
<body class="flex justify-center">

<div id="toast-container"></div>
<div id="app" class="app-container">
    
    <!-- MODAL FOR DELETE CONFIRMATION -->
    <div id="delete-modal-overlay" class="confirm-modal-overlay hidden">
        <div class="confirm-modal text-center">
            <h4 class="text-lg font-semibold mb-4">Confirm Deletion</h4>
            <p class="mb-6 text-gray-600">Are you sure you want to delete this post?</p>
            <div class="flex justify-around">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                    Cancel
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- SIGN IN/SIGN UP VIEW -->
    <div id="auth-view" class="view-content active p-6">
        <div id="auth-box" class="mt-10 p-8 bg-white border border-gray-200 rounded-xl shadow-lg">
            <h2 id="auth-title" class="text-3xl font-bold mb-6 flex justify-center items-center">
                <span class="mr-2 text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-round"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 20c0-1.5-1.5-3-3-3s-3 1.5-3 3"/><path d="M19 12.5V8"/></svg>
                </span>
                Sign In
            </h2>
            <input type="text" id="auth-name" placeholder="Full Name (Sign Up Only)" class="hidden w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <input type="email" id="auth-email" placeholder="Email" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            <input type="password" id="auth-password" placeholder="Password" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
            
            <button id="auth-submit-btn" onclick="handleAuthSubmit()" class="w-full p-3 font-semibold text-white bg-blue-500 rounded-lg hover:bg-blue-600 transition duration-200">
                Sign In
            </button>

            <p class="text-center mt-4 text-sm text-gray-500">
                <span id="toggle-auth-text">No account?</span>
                <a href="#" id="toggle-auth-link" onclick="toggleAuthMode()" class="text-blue-500 hover:text-blue-600 font-semibold ml-1">
                    Sign Up
                </a>
            </p>
        </div>
    </div>

    <!-- FEED VIEW -->
    <div id="feed-view" class="view-content">
        <header class="sticky top-0 z-10 bg-white border-b border-border-color p-4 flex justify-between items-center">
            <h1 id="welcome-message" class="text-xl font-bold"></h1>
            <button onclick="logout()" class="px-3 py-1 bg-red-500 text-white rounded-full text-sm hover:bg-red-600 transition duration-200">
                Logout
            </button>
        </header>

        <!-- Post Creation Area -->
        <div class="p-4 border-b border-border-color bg-white">
            <textarea id="post-input" rows="3" placeholder="What's happening?" 
                      class="w-full resize-none p-2 border-none focus:outline-none text-lg rounded-lg mb-2"></textarea>
            
            <input type="url" id="image-url-input" placeholder="Paste image URL here (Optional)" 
                   class="w-full p-2 mb-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300 text-sm">

            <!-- LOCAL FILE UPLOAD (NOW FUNCTIONAL) -->
            <div class="mb-3 text-sm text-gray-500 border-t border-gray-100 pt-2 flex items-center space-x-2">
                <input type="file" accept="image/*" class="hidden" id="file-upload-input" onchange="handlePostInput()">
                <label for="file-upload-input" class="cursor-pointer text-blue-500 hover:underline font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image inline-block mr-1"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                    Upload Image from Computer (Max 1MB)
                </label>
                <span id="file-name" class="text-gray-700 text-xs truncate max-w-[50%]"></span>
            </div>

            <div class="flex justify-end">
                <button id="post-btn" onclick="createPost()" class="post-button px-5 py-2 text-white bg-blue-500 rounded-full font-bold" disabled>
                    Post
                </button>
            </div>
        </div>

        <!-- Feed Container -->
        <div id="feed-container" class="pb-4">
            <!-- Posts will be dynamically inserted here -->
        </div>
    </div>

</div>

<script>
    // --- JAVASCRIPT LOGIC START ---

    // Global Constants
    const MAX_FILE_SIZE_BYTES = 1024 * 1024; // 1MB Limit for LocalStorage

    // Global State
    let users = JSON.parse(localStorage.getItem('users')) || [];
    let posts = JSON.parse(localStorage.getItem('posts')) || [];
    let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
    let authMode = 'signin'; // 'signin' or 'signup'

    // --- Utility Functions ---

    /** Shows a non-blocking toast notification (replaces alert()). */
    const showToast = (message) => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        
        container.appendChild(toast);
        
        // Show and auto-hide
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => container.removeChild(toast), 300);
        }, 3000);
    };

    /** Saves current state to LocalStorage and triggers a UI render. */
    const saveAndRender = () => {
        localStorage.setItem('users', JSON.stringify(users));
        localStorage.setItem('posts', JSON.stringify(posts));
        if (currentUser) {
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
        } else {
            localStorage.removeItem('currentUser');
        }
        loadFeed();
    };

    /** Switches between signin and signup mode UI. */
    const toggleAuthMode = () => {
        const nameInput = document.getElementById('auth-name');
        const title = document.getElementById('auth-title');
        const submitBtn = document.getElementById('auth-submit-btn');
        const toggleText = document.getElementById('toggle-auth-text');
        const toggleLink = document.getElementById('toggle-auth-link');
        const iconHtml = `<span class="mr-2 text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-round"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 20c0-1.5-1.5-3-3-3s-3 1.5-3 3"/><path d="M19 12.5V8"/></svg>
                </span>`;

        if (authMode === 'signin') {
            authMode = 'signup';
            nameInput.classList.remove('hidden');
            title.innerHTML = `${iconHtml} Create Account`;
            submitBtn.textContent = 'Sign Up';
            toggleText.textContent = 'Already have an account?';
            toggleLink.textContent = 'Sign In';
        } else {
            authMode = 'signin';
            nameInput.classList.add('hidden');
            title.innerHTML = `${iconHtml} Sign In`;
            submitBtn.textContent = 'Sign In';
            toggleText.textContent = 'No account?';
            toggleLink.textContent = 'Sign Up';
        }
    };

    /** Handles form submission for both Sign In and Sign Up. */
    const handleAuthSubmit = () => {
        if (authMode === 'signup') {
            signUp();
        } else {
            signIn();
        }
    };

    // --- Authentication ---

    const signUp = () => {
        const name = document.getElementById('auth-name').value.trim();
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;

        if (!name || !email || !password) return showToast("Please fill in all fields.");
        if (users.find(u => u.email === email)) return showToast("This email is already registered.");

        users.push({ id: Date.now(), name, email, password });
        localStorage.setItem('users', JSON.stringify(users));
        showToast("Account created successfully! Please sign in.");
        toggleAuthMode();
    };

    const signIn = () => {
        const email = document.getElementById('auth-email').value.trim();
        const password = document.getElementById('auth-password').value;

        const user = users.find(u => u.email === email && u.password === password);

        if (user) {
            currentUser = user;
            saveAndRender();
            showView('feed-view');
        } else {
            showToast("Invalid email or password.");
        }
    };

    const logout = () => {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showView('auth-view');
        // Clear inputs after logout
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
        if (document.getElementById('auth-name')) document.getElementById('auth-name').value = '';
        showToast("Logged out successfully.");
    };

    // --- Post CRUD & Interactions ---

    /** Enables the Post button if text, URL, or a file is selected. */
    const handlePostInput = () => {
        const postInput = document.getElementById('post-input');
        const button = document.getElementById('post-btn');
        const imageUrlInput = document.getElementById('image-url-input');
        const fileInput = document.getElementById('file-upload-input');
        
        // Show file name if selected
        document.getElementById('file-name').textContent = fileInput.files.length > 0 ? fileInput.files[0].name : '';

        // Enable if post text OR image URL OR file is present
        const hasContent = postInput.value.trim() !== '' || imageUrlInput.value.trim() !== '' || fileInput.files.length > 0;
        button.disabled = !hasContent;
    };
    
    // Helper function to read file asynchronously
    const convertToBase64 = (file) => {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    };
    
    // Finalizes post creation after optional Base64 conversion
    const finalizePostCreation = (content, imageUrl, base64Image) => {
        const newPost = {
            id: Date.now(),
            userId: currentUser.id,
            userName: currentUser.name,
            content: content,
            imageUrl: imageUrl,
            base64Image: base64Image, // New property for local uploads (Base64 string)
            timestamp: new Date().toLocaleString(),
            likes: [], 
            comments: [] 
        };

        posts.unshift(newPost);
        saveAndRender();
        
        // Clear inputs after posting
        document.getElementById('post-input').value = "";
        document.getElementById('image-url-input').value = "";
        document.getElementById('file-upload-input').value = "";
        document.getElementById('file-name').textContent = "";
        document.getElementById('post-btn').disabled = true;
        showToast("Post uploaded!");
    };


    const createPost = async () => {
        const postInput = document.getElementById('post-input');
        const imageUrlInput = document.getElementById('image-url-input');
        const fileInput = document.getElementById('file-upload-input');

        const content = postInput.value.trim();
        const imageUrl = imageUrlInput.value.trim();
        const file = fileInput.files[0];

        if (!content && !imageUrl && !file) return;

        let base64Image = null;

        if (file) {
            if (file.size > MAX_FILE_SIZE_BYTES) {
                showToast("File size limit exceeded (Max 1MB for local storage).");
                fileInput.value = ''; // Clear file input
                handlePostInput();
                return;
            }
            // If file exists and is under limit, convert it to Base64
            try {
                // Show a temporary loading indicator (disabling post button)
                document.getElementById('post-btn').textContent = 'Uploading...';
                document.getElementById('post-btn').disabled = true;
                
                base64Image = await convertToBase64(file);
                
                document.getElementById('post-btn').textContent = 'Post';

            } catch (error) {
                showToast(`Error reading file: ${error.message}`);
                document.getElementById('post-btn').textContent = 'Post';
                handlePostInput(); // Re-enable if other content exists
                return;
            }
        }
        
        // Finalize post creation
        finalizePostCreation(content, imageUrl, base64Image);
    };

    const deletePost = (postId) => {
        // Show custom delete confirmation modal
        const modal = document.getElementById('delete-modal-overlay');
        modal.classList.remove('hidden');

        document.getElementById('modal-confirm').onclick = () => {
            posts = posts.filter(p => p.id !== postId);
            saveAndRender();
            showToast("Post deleted.");
            modal.classList.add('hidden');
        };

        document.getElementById('modal-cancel').onclick = () => {
            modal.classList.add('hidden');
        };
    };

    const editPost = (postId) => {
        const post = posts.find(p => p.id === postId);
        // Using prompt as a functional stand-in for a custom input modal
        const newContent = prompt("Edit your post text:", post.content); 
        if (newContent !== null && newContent.trim() !== "") {
            post.content = newContent.trim();
            saveAndRender();
            showToast("Post updated.");
        }
    };

    const toggleLike = (postId) => {
        const post = posts.find(p => p.id === postId);
        const userId = currentUser.id;
        const index = post.likes.indexOf(userId);

        if (index > -1) {
            post.likes.splice(index, 1); // Unlike
            showToast("Unliked post.");
        } else {
            post.likes.push(userId); // Like
            showToast("Liked post! ‚ù§Ô∏è");
        }
        saveAndRender();
    };

    const addComment = (postId) => {
        // Using prompt as a functional stand-in for a custom input modal
        const commentText = prompt("Write your comment:"); 
        if (commentText && commentText.trim() !== "") {
            const post = posts.find(p => p.id === postId);
            post.comments.push({
                userId: currentUser.id,
                userName: currentUser.name,
                text: commentText.trim()
            });
            saveAndRender();
            showToast("Comment added.");
        }
    };

    // --- Rendering Functions ---

    /** Switches the visible UI view. */
    const showView = (viewId) => {
        document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    };

    const loadFeed = () => {
        if (!currentUser) return; // Guard clause

        document.getElementById('welcome-message').textContent = `Hello, ${currentUser.name}!`;
        const container = document.getElementById('feed-container');
        container.innerHTML = ''; // Clear previous feed

        posts.forEach(post => {
            const isOwner = post.userId === currentUser.id;
            const isLiked = post.likes.includes(currentUser.id);

            const postElement = document.createElement('div');
            postElement.className = 'post border-b border-border-color p-4 hover:bg-gray-50 transition duration-150';

            // Owner Actions Menu
            const ownerActions = isOwner ? `
                <div class="relative">
                    <button class="text-gray-500 hover:text-gray-700 font-semibold text-sm mr-2" onclick="editPost(${post.id})">Edit</button>
                    <button class="text-red-500 hover:text-red-700 font-semibold text-sm" onclick="deletePost(${post.id})">Delete</button>
                </div>
            ` : '';

            // Image Content: prioritize Base64 (local) over external URL
            const imageSource = post.base64Image || post.imageUrl;
            
            const imageContent = imageSource ? `
                <div class="my-3 rounded-xl overflow-hidden shadow-md">
                    <img src="${imageSource}" alt="User post image" class="w-full h-auto object-cover" 
                         onerror="this.onerror=null; this.src='https://placehold.co/600x400/FF0000/FFFFFF?text=Image+Load+Failed';">
                </div>
            ` : '';


            // Post Structure
            postElement.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <strong class="font-bold text-base">${post.userName}</strong>
                        <span class="text-gray-500 text-xs block">${post.timestamp}</span>
                    </div>
                    ${ownerActions}
                </div>
                
                ${post.content ? `<p class="mb-3 whitespace-pre-wrap">${post.content}</p>` : ''}
                ${imageContent}
                
                <!-- Actions Bar -->
                <div class="flex justify-around border-t border-border-color pt-2">
                    <button onclick="toggleLike(${post.id})" class="flex items-center space-x-1 text-sm ${isLiked ? 'text-red-500 font-bold' : 'text-gray-500 hover:text-red-500'} transition duration-150">
                        ${isLiked ? '‚ù§Ô∏è' : 'ü§ç'} <span>${post.likes.length} Likes</span>
                    </button>
                    <button onclick="addComment(${post.id})" class="flex items-center space-x-1 text-sm text-gray-500 hover:text-blue-500 transition duration-150">
                        üí¨ <span>Comment (${post.comments.length})</span>
                    </button>
                </div>

                <!-- Comments Section -->
                ${post.comments.length > 0 ? `
                    <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                        <h4 class="text-sm font-semibold mb-2 text-gray-700">Comments:</h4>
                        ${post.comments.map(c => `
                            <p class="text-sm mb-1">
                                <strong class="text-blue-600">${c.userName}:</strong> ${c.text}
                            </p>
                        `).join('')}
                    </div>
                ` : ''}
            `;
            container.appendChild(postElement);
        });
    };

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', () => {
        // Attach listener for post button
        document.getElementById('post-input').addEventListener('input', handlePostInput);
        document.getElementById('image-url-input').addEventListener('input', handlePostInput);
        // The file input listener is now attached via onchange in HTML, but we ensure the check runs:
        
        // Check authentication status and render the correct view
        if (currentUser) {
            showView('feed-view');
            loadFeed();
        } else {
            showView('auth-view');
        }
    });
</script>
</body>
</html>